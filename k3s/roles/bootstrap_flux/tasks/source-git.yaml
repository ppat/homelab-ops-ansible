---
- name: "source-git | Create secret with git ssh key for flux git source"
  ansible.builtin.command: >
    flux create secret git flux-system-git-secret
    --url {{ config.flux.source.git.url }}
    --private-key-file {{ config.flux.source.git.ssh_key }}
    --kubeconfig {{ kubeconfig_location }}

- name: "source-git | Bootstrap flux with git repository as a source"
  ansible.builtin.command: >
    kubectl apply --kubeconfig {{ kubeconfig_location }} --server-side -f {{ bootstrap_flux_tempdir.path }}/
  register: bootstrap_flux_source_status
  changed_when: bootstrap_flux_source_status.stdout_lines | community.general.json_query("[?ends_with(@, 'unchanged')]") | length != 2
