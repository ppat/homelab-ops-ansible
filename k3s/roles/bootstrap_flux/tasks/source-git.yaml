---
- name: "Create secret with git ssh key for flux"
  ansible.builtin.command: >
    flux create secret git flux-system-git-secret
    --url {{ config.flux.source.git.url }}
    --private-key-file {{ config.flux.source.git.ssh_key }}
    --kubeconfig {{ kubeconfig_location }}

- name: "Configure flux with git repository as a source"
  ansible.builtin.shell: |
    #!/bin/bash
    set -eo pipefail
    export FLUX_GIT_BRANCH="{{ config.flux.source.git.branch | default('') }}"
    kustomize build {{ config.flux.source.manifest }}/ | envsubst > /tmp/flux_build.yaml
    kubectl apply --kubeconfig {{ kubeconfig_location }} --server-side -f /tmp/flux_build.yaml
  args:
    executable: /bin/bash
  register: bootstrap_flux_flux_root_status
  changed_when: bootstrap_flux_flux_root_status.stdout_lines | community.general.json_query("[?ends_with(@, 'unchanged')]") | length != 2
