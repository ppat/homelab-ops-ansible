---
- name: "Check for mandatory variables definitions"
  ansible.builtin.assert:
    that:
    - flux_bootstrap is defined and flux_bootstrap|length > 0
    - flux_bootstrap.prerequisites is defined
    - flux_bootstrap.source is defined and flux_bootstrap.source|length > 0
    - flux_bootstrap.source.git is defined and flux_bootstrap.source.git|length > 0
    - flux_bootstrap.source.git.url is defined and flux_bootstrap.source.git.url is url(schemes=['ssh'])
    - flux_bootstrap.source.git.ssh_key is defined

- name: "Check if flux root source secret exists"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_location }}"
    namespace: flux-system
    kind: Secret
    name: "flux-root-source-secret"
  register: bootstrap_flux_source_secret

- name: "Prepare prerequisites for flux bootstrap"
  when: bootstrap_flux_source_secret.resources|length == 0
  ansible.builtin.import_tasks: prepare-prerequisites.yaml

- name: "Create pre-requisite kubernetes resources for flux bootstrap"
  when: bootstrap_flux_source_secret.resources|length == 0
  ansible.builtin.command: >
    kubectl apply
    --kubeconfig {{ kubeconfig_location }}
    --kustomize {{ prerequisites_tempdir.path }}/
  register: bootstrap_flux_prerequisites_status
  changed_when: >
    (bootstrap_flux_prerequisites_status.stdout_lines | community.general.json_query("[?ends_with(@, 'created')]") | length > 0)
    or
    (bootstrap_flux_prerequisites_status.stdout_lines | community.general.json_query("[?ends_with(@, 'changed')]") | length > 0)

- name: "Prepare bootstrap settings manifest for flux bootstrap"
  when: bootstrap_flux_source_secret.resources|length == 0
  ansible.builtin.import_tasks: prepare-bootstrap.yaml

- name: "Create flux source and bootstrap cluster from source"
  when: bootstrap_flux_source_secret.resources|length == 0
  ansible.builtin.include_tasks: "source-git.yaml"

- name: "Cleanup temp directories and files"
  when: bootstrap_flux_source_secret.resources|length == 0
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
  - "{{ bootstrap_flux_tempdir.path }}"
  - "{{ prerequisites_tempdir.path }}"
  changed_when: false
